
\begin{frame}
  
\frametitle{Outline of this lecture} 

\begin{itemize}

\item Theory of Markov modelling

\item Example: Estimating Markov model transition probabilities from
  individual-level counts of transitions

\item Bayesian inference ideas
  \begin{itemize}
  \item Dirichlet and Multinomial distributions
  \item Advantages of Bayes: including prior information, natural
    quantification of uncertainty (probabilistic sensitivity
    analysis).
  \end{itemize}

\item Implementing Markov models in \texttt{R}

\item Brief discussion of decision modelling more generally, from
  Bayesian perspective
\end{itemize}


\end{frame}


%### New page ############################################################



\frame{
  \frametitle{Markov models in discrete time}

  Assume 
  \begin{itemize}

  \item a set of $S$ ``clinically relevant'' states: exhaustive and mutually exclusive

  \item a discrete time axis, indexed by ``cycles'' or time units $j$

  \item a set of allowed transitions in a diagram of the states
  \end{itemize} 
  
  Arrows connecting two states denote that a person can move
  \begin{itemize}
  \item  from the state at the start of the arrow at time $j$ 
  \item  to the state at the end of the arrow at time $j+1$
  \item Absence of an arrow implies transition is not allowed by model
  \end{itemize}


  \pause
Movements occur according to suitable \alert{\textit{transition probabilities}}
\[ \myblue \bm{\pi}_j = \bm{\pi}_{j-1}\bm\Lambda_j \]
\begin{itemize}
\item $\myblue \bm{\pi}_j$ is the vector of probabilities of occupying each state at time $j$
\item $\myblue \bm\Lambda_j = [\Lambda_{j;s,s'}]$ is the \alert{transition probability matrix} at time $j$: $s,s'$ entry is the probability of moving from state $s$ to state $s'$ at time $j$
\end{itemize}

}

\frame{
\frametitle{Markov models}
\only<1|handout:1>{1.\ Define a structure}
\only<2|handout:2>{2.\ Estimate the transition probabilities from available, relevant data\\Define costs and utilities associated with occupying each state $s$ at each time $j$}
\only<3|handout:3>{3.\ Run the simulation, recording:\\ proportion of people in each state $\rightarrow$ expected costs and effects,\\ at each time:\\ $j=0$}
\only<4|handout:4>{3.\ Run the simulation: $j=1$}
\only<5|handout:5>{3.\ Run the simulation: $j=2$}
\only<6|handout:6>{3.\ Run the simulation: $j=3$}
\only<7|handout:7>{3.\ Run the simulation: $j=J$}
\begin{figure}
\begin{tikzpicture}
\draw(0,1.5) node[align=center,ellipse,draw,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](1){Disease};

\draw(-2.5,0) node[align=center,ellipse,draw,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](2){In health};

\draw(2.5,0) node[align=center,ellipse,draw,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](3){Death};

\draw(0,-1.5) node[align=center,ellipse,draw,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](4){Recovery};

\only<2-|handout:2->{
\draw(-1.4,1.6) node[align=center,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](5){$\lambda_{22}$};

\draw(-4.0,0) node[align=center,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](6){$\lambda_{11}$};

\draw(-1.7,.9) node[align=center,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](7){$\lambda_{12}$};

\draw(1.7,.9) node[align=center,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](8){$\lambda_{24}$};

\draw(-.8,.2) node[align=center,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](9){$\lambda_{14}$};

\draw(4,0) node[align=center,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](10){$\lambda_{44}$};

\draw(.35,-.6) node[align=center,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](11){$\lambda_{23}$};

\draw(-1.7,-.8) node[align=center,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](12){$\lambda_{31}$};

\draw(1.7,-.8) node[align=center,fill=none,font=\sffamily\fontsize{9}{10}\selectfont,minimum width=1.8cm,minimum height=.7cm](13){$\lambda_{34}$};
}

\draw(-2.5,-1.7) node(box_healthy){
\begin{minipage}{0.1\textwidth}
\only<1-2|handout:1-2>{\white
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom
}
\only<3|handout:3>{\blue
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom
}
\only<4|handout:4>{\blue
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Gentsroom \white \Ladiesroom \Ladiesroom \Gentsroom \Ladiesroom \Gentsroom
}
\only<5|handout:5>{\blue
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \white \Gentsroom \Ladiesroom \\
\Gentsroom \Ladiesroom \Ladiesroom \white\Gentsroom \Ladiesroom \Gentsroom
}
\only<6|handout:6>{\blue
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\white \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Gentsroom \Ladiesroom \Ladiesroom \white\Gentsroom \Ladiesroom \Gentsroom
}
\only<7|handout:7>{\white
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Ladiesroom \Gentsroom
}
\end{minipage}
};

\draw(3,-1.5) node(box_dead){
\begin{minipage}{0.1\textwidth}
\only<1-3|handout:1-3>{\white
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom
}
\only<4|handout:4>{
\Gentsroom \Ladiesroom \white \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Ladiesroom \Gentsroom
}
\only<5|handout:5>{
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \white \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Ladiesroom \Gentsroom
}
\only<6|handout:6>{
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \white \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Ladiesroom \Gentsroom
}
\only<7|handout:7>{
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \\
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom \Ladiesroom \\
\Ladiesroom \Gentsroom \Ladiesroom \Ladiesroom \Gentsroom \Gentsroom
}
\end{minipage}
};

\draw(0.4,2.1) node(box_disease){
\begin{minipage}{0.1\textwidth}
\only<1-3|handout:1-3>{\white
\Gentsroom \Ladiesroom \Ladiesroom \Gentsroom 
}
\only<4|handout:4>{\red
\Gentsroom \Ladiesroom \Ladiesroom
}
\only<5|handout:5>{\red 
\Gentsroom \Ladiesroom \Gentsroom \Ladiesroom 
}
\only<6|handout:6>{\red 
\Gentsroom \Ladiesroom \Gentsroom 
}
\only<7|handout:7>{\white
\Gentsroom \Ladiesroom \Gentsroom 
}
\end{minipage}
};

\draw(0.4,-2.1) node(box_recovery){
\begin{minipage}{0.1\textwidth}
\only<1-4|handout:1-4>{\white
\Gentsroom \Ladiesroom  
}
\only<5|handout:5>{\green
\Gentsroom 
}
\only<6|handout:6>{\green
\Gentsroom \Gentsroom 
}
\only<7|handout:7>{\white
\Gentsroom \Gentsroom 
}
\end{minipage}
};

\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (1.south) -- (4.north);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.40) -- (1.200);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2.east) -- (3.west);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (4.140) -- (2.300);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (4.40) -- (3.220);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (1.330) -- (3.140);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (1) to [out=195, in=160, looseness=3.5] (1);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (2) to [out=195, in=160, looseness=3.5] (2);
\draw [->,>=latex,shorten >=0pt,auto,node distance=3cm,ultra thin] (3) to [out=345, in=20, looseness=3.5] (3);


\end{tikzpicture}
\end{figure}
}

%### New page ############################################################

\begin{frame}

\frametitle{Markov assumption (discrete time)}

\alert{Markov} models are multi-state models in which next transition
depends only on the current state
\begin{eqnarray*}
&&\Pr(\mbox{state $s'$ at time $j+1 \mid$ history of the process}) = \\
&&\qquad \Pr(\mbox{state $s'$ at time $j+1\mid$ state $s$ at time $j$})
%%%
%%%&&\Pr(\mbox{state} \: j \: \mbox{at \: time} \: t+1\mid\mbox{history \: of \: process})=  \\
%%%&&\qquad \Pr(\mbox{state} \: j \: \mbox{at \: time} \: t+1\mid\mbox{state} \: i \: \mbox{at \: time} \:t)
\end{eqnarray*}

\pause

A Markov model is \alert{time-homogeneous} if this transition probability is the same for all times $j$.  
\begin{itemize}
\item Counterexample: risk of death depends on age.
\end{itemize}

\pause

Non-Markov models can often be made Markov by adding extra states
\begin{itemize}
\item e.g. states \structure{health}$\rightarrow$\structure{disease}$\rightarrow$ \structure{death}
\item suppose risk of death changes with time spent with disease
\item split \structure{disease} into \structure{``early disease''}$\rightarrow$\structure{''late disease''}, with differing risks of death 
\end{itemize}

Remember these models are only approximations to a true process that is usually continuous-time, continuous-state

\end{frame}




\begin{frame}
\addtobeamertemplate{footnote}{}{\vspace{5ex}}
\frametitle{Example: asthma\footnote{Briggs A, Ades AE and Price MJ. \href{http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.938.9909&rep=rep1&type=pdf}{Medical Decision Making (2003); 23:341-350}\\}}
Five-state model for management of asthma:
\bi
\item STW: Successfully treated week
\item UTW: Unsuccessfully treated week
\item Hex: Hospital-managed exacerbation
\item Pex: Primary care-managed exacerbation
\item TF: Treatment failure - enters a ``usual care'' pattern (absorbing)
\ei

\begin{center}
\rotatebox{0}{\includegraphics[height=3.5cm]{11.markov-models/figs/5state.pdf}}
\end{center}

\end{frame}


%### New page ############################################################

\begin{frame}

\frametitle{Data}

Estimate the Markov model transition probabilities using individual-level transition data

\bi
\item From a RCT with 2 treatments

\bi
\item SFC: Salmeterol (50$\mu$g) / fluticasone propionate (100$\mu$g) in combination
  \begin{itemize}
  \item new treatment, $t=2$
  \end{itemize}
\item FP: Fluticasone propionate alone (100$\mu$g) 
  \begin{itemize}
  \item existing treatment, $t=1$
  \end{itemize}
  \ei

\item 12 week trial

\item For each arm we count the number of transitions between states from week $j$ to $j+1$

\item From the Markov assumption, these can be considered independent
\ei

\end{frame}

%### New page ############################################################

\begin{frame}

\frametitle{Data}

\begin{center}
\begin{tabular}{l|rrrrr|r} \hline
\multicolumn{7}{c}{SFC} \\ \hline
&\multicolumn{5}{c|}{Number in state at week $j+1$}&Total in state \\
$r_{ss'}$&STW&UTW&Hex&Pex&TF&at week $j$ ($n_s$)\\ \hline
STW & 210 &  60 & 0 & 1 &  1 & 272 \\
UTW &  88 & 641 & 0 & 4 & 13 & 746 \\
Hex &   0 &   0 & 0 & 0 &  0 &   0 \\
Pex &   1 &   0 & 0 & 0 &  1 &   2 \\
TF  &   0 &   0 & 0 & 0 & 81 &  81 \\ \hline \hline
\multicolumn{7}{c}{FP} \\ \hline
STW &  66 &  32 & 0 & 0 &  2 & 100 \\
UTW &  42 & 752 & 0 & 5 & 20 & 819 \\
Hex &   0 &   0 & 0 & 0 &  0 &   0 \\
Pex &   0 &   4 & 0 & 1 &  0 &   5 \\
TF  &   0 &   0 & 0 & 0 &156 & 156 \\ \hline
\end{tabular}
\end{center}

These are summed over all weeks

\end{frame}

%### New page ############################################################

\begin{frame}

\frametitle{Estimating transition probabilities}


 Could estimate $(s,s')$ transition probability by dividing total 
\begin{itemize}
\item number of transitions observed from $s$ to $s'$, by 
\item number of weeks observed in state $s$ 
\end{itemize}

 But can't estimate transition rates out of Hex since nobody went
  into~Hex! \\
 Also very few went into Pex
  \begin{itemize}
  \item estimates / SEs for rates \alert{out of} Pex will be unstable.
  \end{itemize}

 Economic model needs to
  \begin{itemize}
  \item   include possibility of Hex / Pex --
  expensive states! 
\item account for \alert{uncertainty} in the transition
  rates.
  \end{itemize}



  $\rightarrow$ use Bayesian inference
  \begin{itemize}
  \item   -- combine \alert{priors} on
Hex/Pex/other states with data
\item  $\rightarrow$ \alert{posterior}
distribution of transition probabilities.
  \end{itemize}

\end{frame}

%### New page ############################################################

\begin{frame}

\frametitle{Binomial distribution for an event}

Suppose there are two states in the model (\emph{successfully treated
  week} / \emph{treatment failure}).

Out of $n$ people currently under treatment, the following week $r$
people have had treatment failure.

\begin{center}
\input{11.markov-models/figs/2state.pstex_t}
\end{center}

\begin{center}
\begin{tabular}{l||rr}
\hline
Total in STW at $j$ & \multicolumn{2}{c}{Number in state at $j+1$}\\
at week $j$ & STW & TF  \\ \hline
$n$ & $n-r$ & $r$ \\ \hline
\end{tabular}
\end{center}

Beta distribution is a convenient prior for $\lambda$ (conjugacy)

\end{frame}

%### New page ############################################################

%%%%%%\begin{frame}
%%%%%%
%%%%%%\frametitle{Bayesian estimation of binomial model}
%%%%%%
%%%%%%As in drug example, Lectures 1/2. \\ \alert{Likelihood} 
%%%%%%\[
%%%%%%\begin{array}{lllll}
%%%%%%r &\sim &\mbox{Binomial} (\lambda,n)&& \\
%%%%%%\displaystyle p(r\mid\lambda) &=& \frac{n!}{r!(n-r!)}\lambda^r(1-\lambda)^{n-r} &\propto& \lambda^r(1-\lambda)^{n-r}
%%%%%%\end{array}
%%%%%%\]
%%%%%%\alert{Prior}
%%%%%%\[
%%%%%%\begin{array}{lllll}
%%%%%%\lambda &\sim &\mbox{Beta} (a,b)&&  \\
%%%%%%\displaystyle p(\lambda) &=& \frac{\Gamma(a+b)}{\Gamma(a)\Gamma(b)}\lambda^{a-1}(1-\lambda)^{b-1} &\propto& \pi^{a-1}(1-\pi)^{b-1} 
%%%%%%\end{array}
%%%%%%\]
%%%%%%(e.g. prior ignorance: Beta(1,1): uniform (flat) prior on 0--1)
%%%%%%
%%%%%%\alert{Posterior}
%%%%%%\begin{eqnarray}
%%%%%%p(\lambda\mid r) &\propto& \lambda^{a+r-1}(1-\lambda)^{b+n-r-1} \nonumber \\
%%%%%%\lambda\mid r &\sim &\mbox{Beta} (a+r,b+n-r) \nonumber 
%%%%%%\end{eqnarray}
%%%%%%
%%%%%%
%%%%%%\end{frame}
%%%%%%


%### New page ############################################################

\begin{frame}

\frametitle{Multinomial model for several events}

\begin{center}
\input{11.markov-models/figs/5state-1row.pstex_t}
\end{center}

%$\sum \pi_j=1$ 

\begin{center}
\begin{tabular}{ccccc|c} \\ \hline
\multicolumn{5}{c|}{Number in state at $j+1$}&Total in STW at $j$ \\
STW&UTW&Hex&Pex&TF&at week $j$ \\ \hline
$r_1$ & $r_2$ & $r_3$ & $r_4$ &  $r_5$ & $n$ \\ \hline
\end{tabular}
\end{center}


\end{frame}

%### New page ############################################################

\begin{frame}

\frametitle{Bayesian estimation of multinomial model}
%\vspace{-1.5cm}

\textbf{Likelihood}
\myblue
\[
\begin{array}{lllll}
r_1, \ldots, r_5  &\sim &\multicolumn{3}{l}{\mbox{Multinomial} (\lambda_1, \ldots, \lambda_5,n)} \\
p(\bm r\mid\bm\lambda) &=& \frac{n!}{r_1! \cdots r_5!}\lambda_1^{r_1} \ldots \lambda_5^{r_5} &\propto& \lambda_1^{r_1} \ldots \lambda_5^{r_5} \\
\sum \lambda_s &=& 1
\end{array}
\]

\black  
\textbf{Prior distribution for five transition probabilities}
\myblue
\[
\begin{array}{lllll}
(\lambda_1,\ldots,\lambda_5) &\sim &\mbox{Dirichlet} (a_1,\ldots,a_5)&&  \\
p(\lambda_1,\ldots,\lambda_5) &=& \frac{\Gamma(a_1+\cdots+a_5)}{\Gamma(a_1)\cdots\Gamma(a_5)}\lambda_1^{(a_1-1)}\cdots\lambda_5^{(a_5-1)} &\propto& \lambda_1^{(a_1-1)}\cdots\lambda_5^{(a_5-1)} 
\end{array}
\] 

\black  
\textbf{Posterior distribution}
\myblue
\begin{eqnarray}
p(\bm\lambda\mid \bm r) &\propto& \lambda_1^{(a_1+r_1-1)}\cdots\lambda_5^{(a_5+r_5-1)} \nonumber \\
\bm\lambda &\sim & \mbox{Dirichlet} (a_1+r_1,\ldots, a_5+r_5)\nonumber 
\end{eqnarray}

\end{frame}

%### New page ############################################################
%%% NEED TO CHECK NOTATION FROM HERE!!!!

\begin{frame}

\frametitle{Dirichlet prior distribution}

\begin{itemize}
\item General prior for a set of numbers that add up to 1. 
\item[] $(p_1, \ldots, p_S) \sim \mbox{Dirichlet}(a_1, \ldots, a_S)$
\begin{itemize}
\item $a_s$ proportional to \alert{expected} probability $p_s$ of outcome $s$
\item scale of the $a_s$ indicates prior \alert{precision} of $(p_1, \ldots, p_S)$
\end{itemize}

\vspace{10pt}
\item \textbf{NB}: $\mbox{Dirichlet} (1,\ldots, 1)$ is a flat prior.
\item Given a sample size $\sum a_s$, $a_s$ is your prior expectation for the number
of patients you would expect in each state $s$
\end{itemize}

\end{frame}

%### New page ############################################################
%%%%%%
%%%%%%\begin{frame}
%%%%%%\frametitle{Coding this in \bugs}
%%%%%%\begin{itemize}
%%%%%%\item Use \bugs to sample from the posterior distribution of the transition probabilities. 
%%%%%%\item Data: counts of patients going from each state $r$ to each state $s$: a \alert{matrix}.
%%%%%%\end{itemize}
%%%%%%
%%%%%%The \texttt{structure} command in \openbugs and \winbugs is a structure for storing data
%%%%%%\texttt{structure(.Data=c(1,2,3,4,5,6),.Dim=c(2,3))}
%%%%%%
%%%%%%The rightmost index is filled first (read across columns, then rows)
%%%%%%so this is a matrix with 2 rows and 3 columns
%%%%%%
%%%%%%\[
%%%%%%\left(
%%%%%%\begin{array}{ccc}
%%%%%%[1,1] & [1,2] & [1,3] \\{}
%%%%%%[2,1] & [2,2] & [3,3] 
%%%%%%\end{array}
%%%%%%\right)
%%%%%%=
%%%%%%\left(
%%%%%%\begin{array}{ccc}
%%%%%%1 & 2 & 3\\
%%%%%%4 & 5 & 6 
%%%%%%\end{array}
%%%%%%\right)
%%%%%%\]
%%%%%%\end{frame}

%### New page ############################################################

%%%%\begin{frame}[fragile]
%%%%
%%%%\frametitle{Multinomial / Dirichlet model in \bugs}
%%%%
%%%%Assuming we don't know the formula for the Dirichlet posterior, we
%%%%could let BUGS sample from it given the prior and the data.  In this
%%%%example:
%%%%
%%%%{\footnotesize \olive
%%%%\begin{verbatim}
%%%%model {
%%%%## Multinomial distribution for r, 
%%%%## i=4 non-absorbing states
%%%%for(s in 1:(S-1)){
%%%%    r.sfc[s,1:S] ~ dmulti(lambda.sfc[s,1:S], n.sfc[s]) 
%%%%    r.fp[s,1:S] ~ dmulti(lambda.fp[s,1:S], n.fp[s])    
%%%%}
%%%%## Dirichlet prior distributions for the 
%%%%## transition probabilities lambda
%%%%for(s in 1:(S-1)){
%%%%    lambda.sfc[s,1:S] ~ ddirch(prior.sfc[s,1:S])
%%%%    lambda.fp[s,1:S] ~ ddirch(prior.fp[s,1:S])
%%%%}
%%%%## Fixed transition probabilities for the absorbing state - 
%%%%## prob 1 of staying there - prob 0 of moving
%%%%for(s in 1:S){
%%%%    lambda.sfc[S,s] <- p.fixed[s]
%%%%    lambda.fp[S,s] <- p.fixed[s]
%%%%}
%%%%} ## end of model
%%%%\end{verbatim}
%%%%}
%%%%\end{frame}

\begin{frame}[fragile]

\frametitle{Multinomial / Dirichlet model in \bugs \hspace{0pt plus 1filll}\small \textbf{(cfr BMHE, \S5.4.1)}}

{\footnotesize \olive
\begin{semiverbatim}
model \{
\blue# Multinomial distribution for r, s=1,...,4: non-absorbing states\olive
   for(s in 1:(S-1))\{
      r.sfc[s,1:S] \mytilde dmulti(lambda.sfc[s,1:S], n.sfc[s]) 
      r.fp[s,1:S] \mytilde dmulti(lambda.fp[s,1:S], n.fp[s])    
   \}

\blue# Dirichlet prior distributions for the transition probabilities lambda\olive
   for(s in 1:(S-1))\{
      lambda.sfc[s,1:S] \mytilde ddirch(prior.sfc[s,1:S])
      lambda.fp[s,1:S] \mytilde ddirch(prior.fp[s,1:S])
   \}

\blue# Fixed transition probabilities for the absorbing state - prob 1 of staying there/prob 0 of moving\olive 
   for(s in 1:S)\{
      lambda.sfc[S,s] <- p.fixed[s]
      lambda.fp[S,s] <- p.fixed[s]
   \}
\} 
\end{semiverbatim}
}
\end{frame}



\begin{frame}[fragile]

  \frametitle{Simulating from a Dirichlet in \R}

  However the Dirichlet posterior is known here. 

  We can simulate directly from a known Dirichlet distribution in \R by
  exploiting that a Dirichlet random vector is a function of Gamma
  random variables:
  \begin{itemize}
  \item Simulate $Z_s \sim \mbox{Gamma}(a_s, 1)$ for $s=1, \ldots, S$. Then
  \item $(Z_1, \ldots,  Z_S) / \sum_{i=1}^S Z_i \sim \mbox{Dirichlet} (a_1,\ldots,a_S)$
  \end{itemize}

  \pause
  
  For example, to simulate 1000 draws from a Dirichlet(1,1,1,1):

  {\footnotesize \olive
\begin{verbatim}
a <- c(1, 1, 1, 1)
dir_rand <- matrix(nrow=1000, ncol=4)
for (i in 1:4)
    dir_rand[,i] <- rgamma(1000, a[i], 1)
dir_rand <- dir_rand / rowSums(dir_rand)
\end{verbatim}
  }

  \pause
  
  Or functions to simulate directly from the Dirichlet are provided in several \R add-on packages available from CRAN, e.g.

  {\footnotesize \olive
\begin{verbatim}
install.packages("VGAM") # if not already installed
library(VGAM)
dir_rand <- rdiric(1000, a)
\end{verbatim}
}
  
\end{frame}


%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}[fragile]
%%%%%
%%%%%\frametitle{Markov model in \openbugs: data format}
%%%%%%\vspace{-5cm}
%%%%%\begin{verbatim}
%%%%%
%%%%%list(
%%%%%
%%%%%r.sfc=structure(.Data=c(210,60,0,1,1, 88,641,0,4,13, 
%%%%%                        0,0,0,0,0, 1,0,0,0,1),.Dim=c(4,5)),
%%%%%n.sfc=c(272,746,0,2),
%%%%%r.fp=structure(.Data=c(66,32,0,0,2, 42,752,0,5,20, 
%%%%%                       0,0,0,0,0, 0,4,0,1,0),.Dim=c(4,5)),
%%%%%n.fp=c(100,819,0,5),
%%%%%prior.sfc=structure(.Data=c(1,1,1,1,1, 1,1,1,1,1, 
%%%%%                            1,1,1,1,1, 1,1,1,1,1),.Dim=c(4,5)),
%%%%%prior.fp=structure(.Data=c(1,1,1,1,1, 1,1,1,1,1, 
%%%%%                           1,1,1,1,1, 1,1,1,1,1),.Dim=c(4,5)),
%%%%%p.fixed=c(0,0,0,0,1)
%%%%%
%%%%%)
%%%%%
%%%%%\end{verbatim}
%%%%%
%%%%%
%%%%%\end{frame}

%### New page ############################################################

%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Estimated transition probabilities}
%%%%%
%%%%%{\small
%%%%%\begin{center}
%%%%%\begin{tabular}{ll|rrrrr|r} \\ \hline
%%%%%&&\multicolumn{5}{c|}{To}&\\
%%%%%&$\pi_{ij}$&STW&UTW&Hex&Pex&TF&Total\\ \hline
%%%%%\multicolumn{8}{c}{SFC} \\ \hline
%%%%%    &STW & 0.762 & 0.220 & 0.004 & 0.007 & 0.007 & 1 \\
%%%%%    &UTW & 0.118 & 0.855 & 0.001 & 0.007 & 0.019 & 1 \\
%%%%%From&Hex & 0.200 & 0.200 & 0.200 & 0.200 & 0.200 & 1 \\
%%%%%    &Pex & 0.289 & 0.143 & 0.142 & 0.142 & 0.284 & 1 \\
%%%%%    &TF  &   0 &   0 & 0 & 0 & 1 &  1 \\ \hline \hline
%%%%%\multicolumn{8}{c}{FP} \\ \hline
%%%%%    &STW & 0.638 & 0.315 & 0.009 & 0.010 & 0.029 & 1 \\
%%%%%    &UTW & 0.052 & 0.914 & 0.001 & 0.007 & 0.026 & 1 \\
%%%%%From&Hex & 0.202 & 0.200 & 0.197 & 0.200 & 0.201 &   1 \\
%%%%%    &Pex & 0.100 & 0.501 & 0.100 & 0.200 & 0.099 &   1 \\
%%%%%    &TF  &  0 &   0 & 0 & 0 & 1 &  1 \\ \hline
%%%%%\end{tabular}
%%%%%\end{center}
%%%%%}
%%%%%\vfill \small
%%%%%\textbf{NB}: Means of the posterior distributions are shown here
%%%%%
%%%%%\end{frame}
%### New page ############################################################

\begin{frame}

\frametitle{Estimated transition probabilities versus observed data}
% \vspace{-2cm}

After obtaining the posterior Dirichet distributions
{\footnotesize

\begin{tabular}{l|rrrrr||rrrrr} \\ \hline
&\multicolumn{5}{c||}{\alert{Raw transition counts}} & \multicolumn{5}{c}{\alert{Bayesian posterior mean}} \\ \hline
    \textbf{To:}&STW&UTW&Hex&Pex&TF  &STW&UTW&Hex&Pex&TF\\ \hline
\textbf{From:}&\multicolumn{10}{c}{SFC} \\ \hline
 STW & 210 &  60 & 0 & 1 &  1 & 0.76 & 0.22 & 0.004 & 0.01 & 0.01  \\  
 UTW &  88 & 641 & 0 & 4 & 13 & 0.12 & 0.85 & 0.001 & 0.01 & 0.02  \\  
 Hex &   0 &   0 & 0 & 0 &  0 & 0.20 & 0.20 & 0.20 & 0.20 & 0.20   \\  
 Pex &   1 &   0 & 0 & 0 &  1 & 0.29 & 0.14 & 0.14 & 0.14 & 0.28   \\  
 TF  &   0 &   0 & 0 & 0 & 81 &   0 &   0 & 0 & 0 & 1              \\ 
 \hline
 &\multicolumn{10}{c}{FP} \\ \hline
 STW &  66 &  32 & 0 & 0 &  2 & 0.64 & 0.31 & 0.01 & 0.01 & 0.03   \\  
 UTW &  42 & 752 & 0 & 5 & 20 & 0.05 & 0.91 & 0.001 & 0.00 & 0.03  \\  
 Hex &   0 &   0 & 0 & 0 &  0 & 0.20 & 0.20 & 0.20 & 0.20 & 0.20   \\  
 Pex &   0 &   4 & 0 & 1 &  0 & 0.10 & 0.50 & 0.10 & 0.20 & 0.10   \\  
 TF  &   0 &   0 & 0 & 0 &156 &  0 &   0 & 0 & 0 & 1               \\ 
 \hline 
\end{tabular}
}

\vfill \small
Information from the prior has been combined with the data

\end{frame}


%### New page ############################################################

%%%%\begin{frame}
%%%%\frametitle{Cost effectiveness modelling}
%%%%
%%%%\begin{center}
%%%%\begin{overpic}[height=6.5cm]{10.markov-models/figs/5state-animation-1.png}
%%%%\only<2->{\put(0,0){\includegraphics[height=6.5cm]{10.markov-models/figs/5state-animation-2.png}}}
%%%%\only<3->{\put(0,0){\includegraphics[height=6.5cm]{10.markov-models/figs/5state-animation-3.png}}}
%%%%\only<4->{\put(0,0){\includegraphics[height=6.5cm]{10.markov-models/figs/5state-animation-4.png}}}
%%%%\end{overpic}
%%%%\end{center}
%%%%
%%%%\end{frame}

%### New page ############################################################

\begin{frame}
\frametitle{Cost-effectiveness modelling}

Calculate \alert{expected costs} and \alert{expected benefits} of each
treatment over the long term:

\begin{itemize}

\item \alert{Cohort simulation:} Estimate proportion of population in each state at each successive time
  (from Markov \emph{transition probabilities})
  \begin{itemize}
  \item at the start, everyone in ``base'' state (e.g. just received treatment) 
  \item usually in the long run, everyone will be in the ``absorbing'' state (e.g.~death)
  \end{itemize}
\vspace{10pt}

\item Assign cost and benefit to each state in model 
\vspace{10pt}

\item Accumulate expected cost and benefit over times

\end{itemize}

\vfill \footnotesize \textbf{NB}: Check BMHE 5.4 + practical!
  
\end{frame}

\frame{
\frametitle{Discounting}
\begin{itemize}

\item Costs and outcomes can occur at different times with respect to when the intervention is implemented

  \begin{itemize}

  \item Society tends to value benefits that arrive closer to the present time more than those that are achievable later in the future

  \end{itemize}

\item \alert{Discounting} accounts for differential timing by reducing the value of costs \& effects in the future

  \begin{itemize}

\item Particularly relevant for economic evaluation spanning over a time horizon $>$ 1 year (e.g. Markov models)
\end{itemize}

\pause

\item If cost at some future time $j$ is $c_{tj}$, then \alert{discounted} cost is $c_{tj}/(1+d)^j$.

\item Discount rate $d$: NICE suggest 3.5\% for costs and outcomes

\item \textbf{Present Value} of intervention (treatment) $t$ over a time horizon $J$ is \color{myblue}
\begin{eqnarray*}
\text{PV}^c_t = \sum_{j=0}^{J}\frac{c_{tj}}{(1+d)^j} \qquad \text{PV}^e_t = \sum_{j=0}^{J}\frac{e_{tj}}{(1+d)^j}
\end{eqnarray*} \color{black}
(for \color{blue}costs $c$ \color{black}and \color{red}clinical benefits $e$\color{black}, respectively)
\end{itemize}
}

%### New page ############################################################

\begin{frame}

\frametitle{Simulating prevalences of states over time}

\begin{itemize}
\item $\pi_{js}$ is the \textbf{expected proportion} of patients in state $s$ at time $j$
\item $\lambda_{ss'}$ is the probability of going from state $s$ to state $s'$ in one time step
\item Thus \myblue 
$$\pi_{j+1,s}=\pi_{j1}\lambda_{1s}+\cdots+\pi_{jS}\lambda_{Ss}$$
\black 
which we can write in matrix form as \myblue
\[
\begin{array}{rcl}
(\pi_{j+1,1},\ldots,\pi_{j+1,S})&=&(\pi_{j,1},\ldots,\pi_{j,S})
\left(
\begin{array}{ccc}
\lambda_{11} & \ldots & \lambda_{1S} \\
\vdots & \ddots & \vdots \\
\lambda_{S1} & \ldots & \lambda_{SS} 
\end{array}
\right) \nonumber \\
\bm{\pi}_{j+1}&=&\bm{\pi}_j \bm\Lambda
\end{array}
\]
\black 
\item \textbf{NB}: $\bm\Lambda$ may depend on time $j$

\pause

\item Instead of calculating \textbf{expected} proportions $\pi_{js}$, could
  simulate the \textbf{absolute number} $m_{js}$ of patients in a
  cohort of size $M$, in state $s$, at time $j$.
  \begin{itemize}
  \item may help to illustrate what model is doing, though decision is generally based on \alert{expected} cost (average cost for an infinite population)
  \end{itemize}
  
\end{itemize}





\end{frame}

% CJ 2019: remove BUGS code, as we don't recommend people use BUGS to do this 
% %### New page ############################################################

% \begin{frame}[fragile]

% \frametitle{Coding this in \bugs}

% {\footnotesize \olive
% \begin{verbatim}
% ## Starting state
% for(s in 1:S){
%     m.sfc[1,s] <- m.start[s]
%     m.fp[1,s]  <- m.start[s]
% }

% ## Markov model
% for(j in 2:J){
%     for(s in 1:S){  # state proportions
%         m.sfc[j,s] <- inprod(m.sfc[j-1,1:S],lambda.sfc[1:S,s]) 
%         m.fp[j,s]  <- inprod(m.fp[j-1,1:S],lambda.fp[1:S,s])
%     }
% }
% ## inprod(v1[1:5],v2[1:5]) = sum_{i=1 to 5} v1_i v2_i
% \end{verbatim}

% \vfill \black 
% \textbf{NB}: Probably best to leave this computation to \texttt{R}, once the simulations for \texttt{lambda.sfc} and \texttt{lambda.fp} are available!

% }
% \end{frame}

\begin{frame}[fragile]
\frametitle{Coding this in \texttt{R} \small{(see BMHE 5.4)}}

Markov cost-effectiveness models can be implemented straightforwardly in \R. 

{\footnotesize \olive
\begin{verbatim}
  pi_sfc <- pi_fp <- array(dim = c(n.sims, # number of PSA samples 
                              S,    # number of states 
                              J+1)) # number of times 
  for (i in 1:n_sims){                # Assumes only 1 patient
      pi_sfc[i,,1] <- c(1,0,0,0,0)    #  initially in the state 
      pi_fp[i,,1] <- c(1,0,0,0,0)     #  'In health'
  }

  for (i in 1:n.sims) {
      for (j in 2:(J+1)){
          for (s in 1:S){
              pi_sfc[i,s,j] <- sum(pi_sfc[i,,j-1]*lambda_sfc[i,,s])
              pi_fp[i,s,j] <- sum(pi_fp[i,,j-1]*lambda_fp[i,,s])
          }
      }
  }
\end{verbatim}
  
%% \vfill \black \textbf{NB}: \texttt{BUGS} increases variables by one dimension (scalars become vectors, vectors become matrices, matrices become arrays...)

}

Many different ways to write code like this: see the questions sheet / solutions for another way. \\

See also \texttt{heemod}, an \R package designed for health economic modelling \url{https://CRAN.R-project.org/package=heemod}

\end{frame}

%### New page ############################################################

\begin{frame}

\frametitle{Costs and utilities}
\begin{itemize}
\item Assign a cost to each state for each treatment
\begin{center}
\begin{tabular}{l|rrrrr} \\ \hline
&\multicolumn{5}{c}{Cost per week (\pounds)} \\
Treatment&STW&UTW&Hex&Pex&TF\\ \hline
SFC & 7.96 & 7.96 & 1821.17 & 100.79 & TF cost (j)\\
FP  & 2.38 & 2.38 & 1815.58 &  95.21 & TF cost (j)\\ \hline
\end{tabular}
\end{center}

\vspace{7pt}
\item In this example, assume the expected cost for week $j$ in SFC group is
$$\myblue \pi_{j1}\times\mathrm{cost}_{(SFC,1)}+\cdots + \pi_{j4}\times\mathrm{cost}_{(SFC,4)}+ \pi_{j5}\times\mbox{TF\:cost}(j) \vspace{-6pt}  \black$$
\begin{itemize}
\item $\displaystyle \myblue \mbox{TF\:cost}(j) = \pi_{j1}\mathrm{cost}_{(FP,1)}+ \cdots + \pi_{j4} \mathrm{cost}_{(FP,4)}$ $=$ average cost over states, weighted by probability of occupying state, under old treatment
\end{itemize}
\vspace{7pt}
\item Utility measure is the number of weeks in the successfully controlled state
\end{itemize}
\end{frame}

%### New page ############################################################

\begin{frame}[fragile]

\frametitle{Expected costs and effects from a Markov model in \R}
%\vspace{-1.5cm}

Combining probabilities of state occupancy (\texttt{pi\_sfc}) with state-specific costs and utilities, for SFC treatment group (with similar code for FP group)

{\footnotesize \olive
\begin{verbatim}
state_costs_sfc <- c(STW=7.96, UTW=7.96, Hex=1821.17, Pex=100.79, TF=NA)
state_util_sfc <- c(1, 0, 0, 0, 0)
cost_sfc <- eff_sfc <- numeric(nsim)

## Loop over PSA samples
for (i in 1:nsim){
    cts <- ets <- numeric(J)

    ## Loop over times j
    for (j in 1:J){
        state_costs_sfc["TF"] <- state_costs_sfc[1:4] %*% pi_sfc[i,1:3,j]
        # costs for time j, averaged over states
        cts[j] <- sum(pi_sfc[i,,j] * state_costs_sfc) 
        # effects for time j, averaged over states
        ets[j] <- sum(pi_sfc[i,,j] * state_util_sfc)  
    }
    # expected costs and effects summed over all times, and averaged over states
    # for PSA sample i
    cost_sfc[i] <- sum(cts) 
    eff_sfc[i] <- sum(ets) 
}
\end{verbatim}
}



%%% REMOVE BUGS CODE (CJ 2019) 

% {\footnotesize \olive
% \begin{verbatim}
% ## Cost at time j from Markov model 
% for(j in 2:J){
%     weekly.cost.tf.fp[j] <- ## cost of TF at time j
%         inprod(m.fp[j,1:4],weekly.cost.fp[1:4])/sum(m.fp[j,]) 
%     cost.sfc[j] <- inprod(m.sfc[j,1:4],weekly.cost.sfc[1:4])
%         + m.sfc[t,5]*weekly.cost.tf.fp[j]  
%     cost.fp[j]  <- inprod(m.fp[j,1:4],weekly.cost.fp[1:4])
%         + m.fp[t,5]*weekly.cost.tf.fp[j]
% }
% ## Costs and utilities
% mu.c[1] <- sum(cost.fp[2:J])
% mu.c[2] <- sum(cost.sfc[2:J])
% delta.c <- mu.c[2] - mu.c[1]
% mu.e[1] <- sum(m.fp[2:J,1])
% mu.e[2] <- sum(m.sfc[2:J,1])
% delta.e <- mu.e[2] - mu.e[1]
% \end{verbatim}
% }

% \vfill 
% \black \textbf{NB}: Again, can do this directly in \texttt{R} (see BMHE 5.4 + practical)!

\end{frame}

%### New page ############################################################

\begin{frame}[fragile]

\frametitle{Summary: Bayesian health economic model}
% \vspace{-1.5cm}

At each iteration of ``probabilistic sensitivity analysis'', for each arm 

\bi
\item \noindent\textbf{Step 1}: 
\bi
\item draw a realization of the transition probabilities $\bm\Lambda$ from their posterior distribution 
\item define starting state and set time $j=1$
\ei

\vspace{5pt}\pause
\item \noindent\textbf{Step 2}: Markov model
\bi
\item Set time $j = j+1$
\item find prevalence of states $\pi_j$ at this time
\item combine $\pi_j$ with state-specific cost and utility to calculate expected cost and utility at this time
\item repeat step 2 up to time horizon $j = J(=13$ in this case) 
\ei

\vspace{5pt}\pause
\item \noindent\textbf{Step 3}: Cost-effectiveness
\bi
\item calculate expected \alert{costs} 
\item calculate expected \alert{effects} (here, proportion of time spent in STW)
  \ei
  summed over times
  \ei

  Gives a sample from the \textbf{posterior distribution} of expected costs and effects:
  vectors \verb+cost_sfc, eff_sfc, cost_fp, eff_fp+ in R code
\end{frame}


%### New page ############################################################

\begin{frame}

\frametitle{Results}
%\vspace{-1.5cm}

Sample from \alert{joint posterior distribution} of costs and effects
for each treatment gives, e.g. 
\begin{itemize}
\item \alert{incremental cost-effectiveness ratio} = mean cost difference / mean benefit difference
\item ``cost-effectiveness plane''
\item incremental net benefit (with CI)
\item cost-effectiveness acceptability curve
\end{itemize}

\begin{center}
\rotatebox{0}{\includegraphics[height=4cm]{11.markov-models/figs/markov5-contour.pdf}}
\rotatebox{0}{\includegraphics[height=4cm]{11.markov-models/figs//markov5-ceac.pdf}}
\end{center}

\end{frame}


\begin{frame}
  \frametitle{Bayesian decision modelling more generally}

  Example given here was simple
  \begin{itemize}
  \item Markov model with all transition probabilities estimated from
    individual-level transition count data.
  \end{itemize}

  Many more complicated examples, e.g. 

  \begin{itemize}

  \item Transition probabilities for baseline disease progression
    estimated from published data

  \item Treatment effects estimated from RCTs /
    (network-)meta-analysis $\rightarrow$ transition probabilities for
    treated groups

  \item Combinations of individual-level and published aggregate data$\ldots$

  \end{itemize}

  Examples in:
  \begin{itemize}
  \item   \bmhe,
  \item   \emph{Evidence Synthesis for Decision Making in Healthcare},
  \item   \url{http://nicedsu.org.uk/technical-support-documents/}
  \end{itemize}
 
\end{frame}


\begin{frame}

  \frametitle{Software strategy for Bayesian health economic modelling} 

  Typical health economic model:
  \begin{itemize}

  \item model is a \alert{deterministic
      function} $f(\theta)$ that transforms basic parameters $\theta$ to expected costs and effects for decision-making

  \item $\theta$ might include transition probabilities in a Markov
    model, or treatment effects (e.g. hazard ratios) that modify
    transition probabilities
  \end{itemize}

  \pause
  Typical software strategy:
  
 \begin{itemize}

 \item $\theta$ estimated from data using a Bayesian statistical model
   \begin{itemize}
   \item \texttt{BUGS} / \texttt{JAGS} / \texttt{Stan} ideal for this
   \item e.g. treatment effects estimated from network meta-analysis
   \end{itemize}
   $\rightarrow$ samples from the posterior distribution of $\theta$

   \pause 
  \item Export samples of $\theta$ to your preferred software for decision
    modelling
    \begin{itemize}
    \item e.g. \R, \texttt{Excel}
    \end{itemize}

  \item Calculate samples from the posterior of expected costs and effects
    $f(\theta)$
    \begin{itemize}
    \item a fully Bayesian decision model

  \item Asthma example can be done completely in \texttt{BUGS} (see practical material) but \texttt{BUGS} language cumbersome for programming harder models 

  \end{itemize}


  \end{itemize}

  \footnotesize
  \url{http://nicedsu.org.uk/technical-support-documents/evidence-synthesis-tsd-series/}:\\ TSD 6 ``Software choices''
  
\end{frame}


%%%%%%### New page ############################################################
%%%%% VERSION 2016
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Summary}
%%%%%
%%%%%\bi
%%%%%\item Assess \alert{long-term} cost-effectiveness based only on
%%%%%  \alert{short-term} data.  
%%%%%
%%%%%\item State-transition (usually \emph{Markov}) models for clinical
%%%%%  histories.
%%%%%
%%%%%\item Commonly implemented in Excel, or specialized software (e.g. TreeAge).
%%%%%
%%%%%\item Bayesian framework lets you \alert{simultaneously} perform 
%%%%%  \begin{itemize}
%%%%%  \item parameter estimation (from short-term data, e.g. meta-analysis), and 
%%%%%  \item probabilistic sensitivity analysis (long-term costs and benefits)
%%%%%  \item - uncertainty about parameters fully included 
%%%%%  \end{itemize}
%%%%%
%%%%%\item Simple example: estimate transition probabilities using
%%%%%  \emph{multinomial} distribution in \bugs.
%%%%%
%%%%%\ei
%%%%%
%%%%%{\footnotesize \emph{Bayesian Methods in Health Economics} chapter 5.4}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Asthma Example}
%%%%%
%%%%%(Briggs, Ades and Price. Medical Decision Making (2003);23:341-350)
%%%%%
%%%%%Five-state model for management of asthma:
%%%%%\bi
%%%%%\item STW: Successfully treated week
%%%%%\item UTW: Unsuccessfully treated week
%%%%%\item Hex: Hospital-managed exacerbation
%%%%%\item Pex: Primary care-managed exacerbation
%%%%%\item TF: Treatment failure - enters a ``usual care'' pattern (absorbing)
%%%%%\ei
%%%%%
%%%%%\begin{center}
%%%%%\rotatebox{0}{\includegraphics[height=3.5cm]{11.markov-models/figs/5state.pdf}}
%%%%%\end{center}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Markov assumption (discrete time)}
%%%%%
%%%%%\alert{Markov} models are multi-state models in which next transition
%%%%%depends only on the current state
%%%%%
%%%%%\begin{eqnarray*}
%%%%%&&p(\mathrm{state} \: j \: \mathrm{at \: time} \: t+1\mid\mathrm{history \: of \: process})=  \\
%%%%%&&\qquad p(\mathrm{state} \: j \: \mathrm{at \: time} \: t+1\mid\mathrm{state} \: i \: \mathrm{at \: time} \:t)
%%%%%\end{eqnarray*}
%%%%%
%%%%%A Markov model is \alert{time-homogeneous} if this transition
%%%%%probability is the same for all times $t$.  
%%%%%\begin{itemize}
%%%%%\item Counterexample: risk of death depends on age.
%%%%%\end{itemize}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Data}
%%%%%
%%%%%Data from a RCT with 2 treatments
%%%%%
%%%%%\bi
%%%%%\item SFC: Salmeterol (50$\mu$g) / fluticasone propionate (100$\mu$g) in combination (new treatment)
%%%%%\item FP: Fluticasone propionate alone (100$\mu$g) (existing treatment)
%%%%%\ei
%%%%%
%%%%%12 week trial
%%%%%
%%%%%For each arm we count the number of transitions between states from week $i$ to $i+1$
%%%%%
%%%%%From the Markov assumption, these can be considered independent.
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Data}
%%%%%
%%%%%\begin{center}
%%%%%\begin{tabular}{l|rrrrr|r} \hline
%%%%%\multicolumn{7}{c}{SFC} \\ \hline
%%%%%&\multicolumn{5}{c|}{Number in state at week $t+1$}&Total in state \\
%%%%%$r_{ij}$&STW&UTW&Hex&Pex&TF&at week $t$ ($n_i$)\\ \hline
%%%%%STW & 210 &  60 & 0 & 1 &  1 & 272 \\
%%%%%UTW &  88 & 641 & 0 & 4 & 13 & 746 \\
%%%%%Hex &   0 &   0 & 0 & 0 &  0 &   0 \\
%%%%%Pex &   1 &   0 & 0 & 0 &  1 &   2 \\
%%%%%TF  &   0 &   0 & 0 & 0 & 81 &  81 \\ \hline \hline
%%%%%\multicolumn{7}{c}{FP} \\ \hline
%%%%%STW &  66 &  32 & 0 & 0 &  2 & 100 \\
%%%%%UTW &  42 & 752 & 0 & 5 & 20 & 819 \\
%%%%%Hex &   0 &   0 & 0 & 0 &  0 &   0 \\
%%%%%Pex &   0 &   4 & 0 & 1 &  0 &   5 \\
%%%%%TF  &   0 &   0 & 0 & 0 &156 & 156 \\ \hline
%%%%%\end{tabular}
%%%%%\end{center}
%%%%%
%%%%%These are summed over all weeks
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Estimating transition probabilities}
%%%%%
%%%%%\begin{itemize}
%%%%%\item Could estimate $(r,s)$ transition probability by dividing total 
%%%%%\begin{itemize}
%%%%%\item number of transitions observed from $r$ to $s$, by 
%%%%%\item number of weeks observed in state $r$ 
%%%%%\end{itemize}
%%%%%
%%%%%\item But can't estimate transition rates out of Hex since nobody went
%%%%%  into Hex! 
%%%%%\item Also very few went into Pex -- estimates / SEs for rates out of
%%%%%  Pex will be unstable.
%%%%%\begin{itemize}
%%%%%\item Long-term economic model needs to include possibility of Hex /
%%%%%  Pex -- expensive states! 
%%%%%\item Needs to account for \alert{uncertainty} in the transition
%%%%%  rates.
%%%%%\end{itemize}
%%%%%
%%%%%\end{itemize}
%%%%%
%%%%%$\rightarrow$ use Bayesian inference -- combine \alert{priors} on
%%%%%Hex/Pex/other states with data $\rightarrow$ \alert{posterior}
%%%%%distribution of transition probabilities.
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Binomial distribution for an event}
%%%%%
%%%%%Suppose there are two states in the model (\emph{successfully treated
%%%%%  week} / \emph{treatment failure}).
%%%%%
%%%%%Out of $n$ people currently under treatment, the following week $r$
%%%%%people have had treatment failure.
%%%%%
%%%%%\begin{center}
%%%%%\input{11.markov-models/figs/2state.pstex_t}
%%%%%\end{center}
%%%%%
%%%%%\begin{center}
%%%%%\begin{tabular}{l||rr}
%%%%%\hline
%%%%%Total in STW at $t$ & \multicolumn{2}{c}{Number in state at $t+1$}\\
%%%%%at week $t$ & STW & TF  \\ \hline
%%%%%$n$ & $n-r$ & $r$ \\ \hline
%%%%%\end{tabular}
%%%%%\end{center}
%%%%%
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Bayesian estimation of binomial model}
%%%%%
%%%%%As in drug example, Lecture 3. \\ \alert{Likelihood} 
%%%%%\[
%%%%%\begin{array}{lllll}
%%%%%r &\sim &\mbox{Binomial} (\pi,n)&& \\
%%%%%\displaystyle p(r|\pi) &=& \frac{n!}{r!(n-r!)}\pi^r(1-\pi)^{n-r} &\propto& \pi^r(1-\pi)^{n-r}
%%%%%\end{array}
%%%%%\]
%%%%%\alert{Prior}
%%%%%\[
%%%%%\begin{array}{lllll}
%%%%%\pi &\sim &\mbox{Beta} (a,b)&&  \\
%%%%%\displaystyle p(\pi) &=& \frac{\Gamma(a+b)}{\Gamma(a)\Gamma(b)}\pi^{a-1}(1-\pi)^{b-1} &\propto& \pi^{a-1}(1-\pi)^{b-1} 
%%%%%\end{array}
%%%%%\]
%%%%%(e.g. prior ignorance: Beta(1,1): uniform (flat) prior on 0--1)
%%%%%
%%%%%\alert{Posterior}
%%%%%\begin{eqnarray}
%%%%%p(\pi|r) &\propto& \pi^{a+r-1}(1-\pi)^{b+n-r-1} \nonumber \\
%%%%%\pi|r &\sim &\mathrm{Beta} (a+r,b+n-r) \nonumber 
%%%%%\end{eqnarray}
%%%%%
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Multinomial model for several events}
%%%%%
%%%%%\begin{center}
%%%%%\input{11.markov-models/figs/5state-1row.pstex_t}
%%%%%\end{center}
%%%%%
%%%%%%$\sum \pi_j=1$ 
%%%%%
%%%%%\begin{center}
%%%%%\begin{tabular}{ccccc|c} \\ \hline
%%%%%\multicolumn{5}{c|}{Number in state at $t+1$}&Total in STW at $t$ \\
%%%%%STW&UTW&Hex&Pex&TF&at week $t$ \\ \hline
%%%%%$r_1$ & $r_2$ & $r_3$ & $r_4$ &  $r_5$ & $n$ \\ \hline
%%%%%\end{tabular}
%%%%%\end{center}
%%%%%
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Bayesian estimation of multinomial model}
%%%%%%\vspace{-1.5cm}
%%%%%
%%%%%Likelihood
%%%%%\[
%%%%%\begin{array}{lllll}
%%%%%r_1, \ldots, r_5  &\sim &\multicolumn{3}{l}{\mbox{Multinomial} (\pi_1, \ldots, \pi_5,n)} \\
%%%%%p(\bm r\mid\bm\pi) &=& \frac{n!}{r_1! \cdots r_5!}\pi_1^{r_1} \ldots \pi_5^{r_5} &\propto& \pi_1^{r_1} \ldots \pi_5^{r_5} \\
%%%%%\sum \pi_i &=& 1
%%%%%\end{array}
%%%%%\]
%%%%%Prior distribution for five transition probabilities
%%%%%\[
%%%%%\begin{array}{lllll}
%%%%%(\pi_1,\ldots,\pi_5) &\sim &\mbox{Dirichlet} (a_1,\ldots, a_5)&&  \\
%%%%%p(\pi_1,\ldots,\pi_5) &=& \frac{\Gamma(a_1+\cdots+a_5)}{\Gamma(a_1)\cdots\Gamma(a_5)}\pi_1^{(a_1-1)}\cdots\pi_5^{(a_5-1)} &\propto& \pi_1^{(a_1-1)}\cdots\pi_5^{(a_5-1)} 
%%%%%\end{array}
%%%%%\]
%%%%%Posterior distribution
%%%%%\begin{eqnarray}
%%%%%p(\bm\pi\mid \bm r) &\propto& \pi_1^{(a_1+r_1-1)}\cdots\pi_5^{(a_5+r_5-1)} \nonumber \\
%%%%%\bm\pi &\sim & \mbox{Dirichlet} (a_1+r_1,\ldots, a_5+r_5)\nonumber 
%%%%%\end{eqnarray}
%%%%%
%%%%%
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Dirichlet prior distribution}
%%%%%
%%%%%General prior for a set of numbers that add up to 1. 
%%%%%
%%%%%$(p_1, \ldots, p_m) \sim \mbox{Dirichlet}(a_1, \ldots, a_m)$
%%%%%\begin{itemize}
%%%%%\item $a_j$ proportional to \alert{expected} probability $p_j$ of outcome $j$
%%%%%\item scale of the $a_j$ indicates prior \alert{precision} of $(p_1, \ldots, p_m)$
%%%%%\end{itemize}
%%%%%
%%%%%$\mbox{Dirichlet} (1,\ldots, 1)$ is a flat prior.
%%%%%
%%%%%Given a sample size $\sum a_j$, $a_j$ is your prior expectation for the number
%%%%%of patients you would expect in each state $j$
%%%%%
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Coding this in \bugs}
%%%%%
%%%%%\begin{itemize}
%%%%%\item Use \bugs to sample from the posterior distribution of the transition probabilities. 
%%%%%
%%%%%\item Data: counts of patients going from each state $r$ to each state $s$: a \alert{matrix}.
%%%%%
%%%%%\end{itemize}
%%%%%
%%%%%
%%%%%The \texttt{structure} command in \openbugs and \winbugs is a structure for storing data
%%%%%
%%%%%\texttt{structure(.Data=c(1,2,3,4,5,6),.Dim=c(2,3))}
%%%%%
%%%%%The rightmost index is filled first (read across columns, then rows)
%%%%%so this is a matrix with 2 rows and 3 columns
%%%%%
%%%%%\[
%%%%%\left(
%%%%%\begin{array}{ccc}
%%%%%[1,1] & [1,2] & [1,3] \\{}
%%%%%[2,1] & [2,2] & [3,3] 
%%%%%\end{array}
%%%%%\right)
%%%%%=
%%%%%\left(
%%%%%\begin{array}{ccc}
%%%%%1 & 2 & 3\\
%%%%%4 & 5 & 6 
%%%%%\end{array}
%%%%%\right)
%%%%%\]
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}[fragile]
%%%%%
%%%%%\frametitle{Markov model in \bugs}
%%%%%
%%%%%{\footnotesize 
%%%%%\begin{verbatim}
%%%%%model {
%%%%%## Multinomial distribution for r, 
%%%%%## i=4 non-absorbing states
%%%%%for(i in 1:4){
%%%%%    r.sfc[i,1:5] ~ dmulti(p.sfc[i,1:5], n.sfc[i]) 
%%%%%    r.fp[i,1:5] ~ dmulti(p.fp[i,1:5], n.fp[i])    
%%%%%}
%%%%%## Dirichlet prior distributions for the 
%%%%%## transition probabilities
%%%%%for(i in 1:4){
%%%%%    p.sfc[i,1:5] ~ ddirch(prior.sfc[i,1:5])
%%%%%    p.fp[i,1:5] ~ ddirch(prior.fp[i,1:5])
%%%%%}
%%%%%## Fixed transition probabilities for the absorbing state - 
%%%%%## prob 1 of staying there - prob 0 of moving
%%%%%for(j in 1:5){
%%%%%    p.sfc[5,j] <- p.fixed[j]
%%%%%    p.fp[5,j] <- p.fixed[j]
%%%%%}
%%%%%} ## end of model
%%%%%\end{verbatim}
%%%%%}
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}[fragile]
%%%%%
%%%%%\frametitle{Markov model in \openbugs: data format}
%%%%%%\vspace{-5cm}
%%%%%\begin{verbatim}
%%%%%
%%%%%list(
%%%%%
%%%%%r.sfc=structure(.Data=c(210,60,0,1,1, 88,641,0,4,13, 
%%%%%                        0,0,0,0,0, 1,0,0,0,1),.Dim=c(4,5)),
%%%%%n.sfc=c(272,746,0,2),
%%%%%r.fp=structure(.Data=c(66,32,0,0,2, 42,752,0,5,20, 
%%%%%                       0,0,0,0,0, 0,4,0,1,0),.Dim=c(4,5)),
%%%%%n.fp=c(100,819,0,5),
%%%%%prior.sfc=structure(.Data=c(1,1,1,1,1, 1,1,1,1,1, 
%%%%%                            1,1,1,1,1, 1,1,1,1,1),.Dim=c(4,5)),
%%%%%prior.fp=structure(.Data=c(1,1,1,1,1, 1,1,1,1,1, 
%%%%%                           1,1,1,1,1, 1,1,1,1,1),.Dim=c(4,5)),
%%%%%p.fixed=c(0,0,0,0,1)
%%%%%
%%%%%)
%%%%%
%%%%%\end{verbatim}
%%%%%
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Estimated transition probabilities}
%%%%%
%%%%%{\small
%%%%%\begin{center}
%%%%%\begin{tabular}{ll|rrrrr|r} \\ \hline
%%%%%&&\multicolumn{5}{c|}{To}&\\
%%%%%&$\pi_{ij}$&STW&UTW&Hex&Pex&TF&Total\\ \hline
%%%%%\multicolumn{8}{c}{SFC} \\ \hline
%%%%%    &STW & 0.762 & 0.220 & 0.004 & 0.007 & 0.007 & 1 \\
%%%%%    &UTW & 0.118 & 0.855 & 0.001 & 0.007 & 0.019 & 1 \\
%%%%%From&Hex & 0.200 & 0.200 & 0.200 & 0.200 & 0.200 & 1 \\
%%%%%    &Pex & 0.289 & 0.143 & 0.142 & 0.142 & 0.284 & 1 \\
%%%%%    &TF  &   0 &   0 & 0 & 0 & 1 &  1 \\ \hline \hline
%%%%%\multicolumn{8}{c}{FP} \\ \hline
%%%%%    &STW & 0.638 & 0.315 & 0.009 & 0.010 & 0.029 & 1 \\
%%%%%    &UTW & 0.052 & 0.914 & 0.001 & 0.007 & 0.026 & 1 \\
%%%%%From&Hex & 0.202 & 0.200 & 0.197 & 0.200 & 0.201 &   1 \\
%%%%%    &Pex & 0.100 & 0.501 & 0.100 & 0.200 & 0.099 &   1 \\
%%%%%    &TF  &  0 &   0 & 0 & 0 & 1 &  1 \\ \hline
%%%%%\end{tabular}
%%%%%\end{center}
%%%%%}
%%%%%Means of the posterior distributions are shown here
%%%%%
%%%%%\end{frame}
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Estimated transition probabilities versus observed data}
%%%%%%\vspace{-2cm}
%%%%%{\footnotesize
%%%%%
%%%%%\begin{tabular}{l|rrrrr||rrrrr} \\ \hline
%%%%%
%%%%%&\multicolumn{5}{c||}{\alert{Raw transition counts}} & \multicolumn{5}{c}{\alert{Bayesian posterior mean}} \\ \hline
%%%%%    \textbf{To:}&STW&UTW&Hex&Pex&TF  &STW&UTW&Hex&Pex&TF\\ \hline
%%%%%\textbf{From:}&\multicolumn{10}{c}{SFC} \\ \hline
%%%%% STW & 210 &  60 & 0 & 1 &  1 & 0.76 & 0.22 & 0.004 & 0.01 & 0.01  \\  
%%%%% UTW &  88 & 641 & 0 & 4 & 13 & 0.12 & 0.85 & 0.001 & 0.01 & 0.02  \\  
%%%%% Hex &   0 &   0 & 0 & 0 &  0 & 0.20 & 0.20 & 0.20 & 0.20 & 0.20   \\  
%%%%% Pex &   1 &   0 & 0 & 0 &  1 & 0.29 & 0.14 & 0.14 & 0.14 & 0.28   \\  
%%%%% TF  &   0 &   0 & 0 & 0 & 81 &   0 &   0 & 0 & 0 & 1              \\ 
%%%%% \hline
%%%%% &\multicolumn{10}{c}{FP} \\ \hline
%%%%% STW &  66 &  32 & 0 & 0 &  2 & 0.64 & 0.31 & 0.01 & 0.01 & 0.03   \\  
%%%%% UTW &  42 & 752 & 0 & 5 & 20 & 0.05 & 0.91 & 0.001 & 0.00 & 0.03  \\  
%%%%% Hex &   0 &   0 & 0 & 0 &  0 & 0.20 & 0.20 & 0.20 & 0.20 & 0.20   \\  
%%%%% Pex &   0 &   4 & 0 & 1 &  0 & 0.10 & 0.50 & 0.10 & 0.20 & 0.10   \\  
%%%%% TF  &   0 &   0 & 0 & 0 &156 &  0 &   0 & 0 & 0 & 1               \\ 
%%%%% \hline 
%%%%%\end{tabular}
%%%%%}
%%%%%
%%%%%Information from the prior has been combined with the data. 
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%\frametitle{Cost effectiveness modelling}
%%%%%
%%%%%\begin{center}
%%%%%\begin{overpic}[height=6.5cm]{11.markov-models/figs/5state-animation-1.png}
%%%%%\only<2->{\put(0,0){\includegraphics[height=6.5cm]{11.markov-models/figs/5state-animation-2.png}}}
%%%%%\only<3->{\put(0,0){\includegraphics[height=6.5cm]{11.markov-models/figs/5state-animation-3.png}}}
%%%%%\only<4->{\put(0,0){\includegraphics[height=6.5cm]{11.markov-models/figs/5state-animation-4.png}}}
%%%%%\end{overpic}
%%%%%\end{center}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%\frametitle{Cost effectiveness modelling}
%%%%%
%%%%%Calculate \alert{expected costs} and \alert{expected benefits} of each
%%%%%treatment over the long term:
%%%%%
%%%%%\begin{itemize}
%%%%%
%%%%%\item Assign cost and benefit to each state in model. 
%%%%%
%%%%%\item \alert{Cohort simulation:} Estimate proportion of population in each state at each successive time
%%%%%  (from Markov \emph{transition probabilities})
%%%%%  \begin{itemize}
%%%%%  \item at the start, everyone in ``base'' state (e.g. just received treatment) 
%%%%%  \item usually in the long run, everyone will be in the ``absorbing'' state (e.g. death)
%%%%%  \end{itemize}
%%%%%
%%%%%\item Accumulate expected cost and benefit over times. 
%%%%%
%%%%%\end{itemize}
%%%%%  
%%%%%\end{frame}
%%%%%
%%%%%\frame{
%%%%%\frametitle{Discounting}
%%%%%\begin{itemize}
%%%%%\item Costs and outcomes can occur at different times with respect to when the intervention is implemented
%%%%%\begin{itemize}
%%%%%\item Society tends to value benefits that arrive closer to the present time more than those that are achievable later in the future
%%%%%\end{itemize}
%%%%%\item \alert{Discounting} accounts for differential timing by reducing the value of costs \& effects in the future
%%%%%\begin{itemize}
%%%%%\item Particularly relevant for economic evaluation spanning over a time horizon $>$ 1 year (eg Markov models)
%%%%%\end{itemize}
%%%%%\item Define a discount rate $d$ (NICE suggest 3.5\% for costs and outcomes) and compute the \textbf{Present Value} of intervention (treatment) $t$ as \color{myblue}
%%%%%\begin{eqnarray*}
%%%%%\text{PV}^c_t = \sum_{j=0}^{J}\frac{c_{tj}}{(1+d)^j} \qquad \text{PV}^e_t = \sum_{j=0}^{J}\frac{e_{tj}}{(1+d)^j}
%%%%%\end{eqnarray*} \color{black}
%%%%%(for \color{blue}costs $c$ \color{black}and \color{red}clinical benefits $e$\color{black}, respectively)
%%%%%\end{itemize}
%%%%%}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Simulating prevalences of states over time}
%%%%%
%%%%%$s_{jt}$ is the proportion of patients in state $j$ at time $t$
%%%%%
%%%%%$\pi_{ij}$ is the probability of going for state $i$ to state $j$ in one time step
%%%%%
%%%%%So $s_{t+1,j}=s_{t1}\pi_{1j}+\cdots+s_{t5}\pi_{5j}$
%%%%%
%%%%%Which we can write in matrix form as
%%%%%\[
%%%%%\begin{array}{rcl}
%%%%%(s_{t+1,1},\ldots,s_{t+1,5})&=&(s_{t,1},\ldots,s_{t,5})
%%%%%\left(
%%%%%\begin{array}{ccc}
%%%%%\pi_{11} & \ldots & \pi_{15} \\
%%%%%\vdots & \ddots & \vdots \\
%%%%%\pi_{51} & \ldots & \pi_{55} 
%%%%%\end{array}
%%%%%\right) \nonumber \\
%%%%%s_{t+1}^T&=&s_t^T \Pi
%%%%%\end{array}
%%%%%\]
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}[fragile]
%%%%%
%%%%%\frametitle{Coding this in \bugs}
%%%%%
%%%%%{\footnotesize 
%%%%%\begin{verbatim}
%%%%%## Starting state
%%%%%for(j in 1:5){
%%%%%    s.sfc[1,j] <- s.start[j]
%%%%%    s.fp[1,j]  <- s.start[j]
%%%%%}
%%%%%
%%%%%## Markov model
%%%%%for(t in 2:13){
%%%%%    for(j in 1:5){  # state proportions
%%%%%        s.sfc[t,j] <- inprod(s.sfc[t-1,1:5],p.sfc[1:5,j]) 
%%%%%        s.fp[t,j]  <- inprod(s.fp[t-1,1:5],p.fp[1:5,j])
%%%%%    }
%%%%%}
%%%%%## inprod(v1[1:5],v2[1:5]) = sum_{i=1 to 5} v1_i v2_i
%%%%%## can also use inprod2 which is faster (and not documented)
%%%%%\end{verbatim}
%%%%%}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Costs and utilities}
%%%%%
%%%%%Assign a cost to each state for each treatment
%%%%%
%%%%%\begin{center}
%%%%%\begin{tabular}{l|rrrrr} \\ \hline
%%%%%&\multicolumn{5}{c}{Cost per week (\pounds)} \\
%%%%%Treatment&STW&UTW&Hex&Pex&TF\\ \hline
%%%%%SFC & 7.96 & 7.96 & 1821.17 & 100.79 & TF cost (t)\\
%%%%%FP  & 2.38 & 2.38 & 1815.58 &  95.21 & TF cost (t)\\ \hline
%%%%%\end{tabular}
%%%%%\end{center}
%%%%%
%%%%%Total cost for week $t$ in SFC group is
%%%%%$s_{t1}\mathrm{cost}_{(SFC,1)}+\cdots + s_{t4} \mathrm{cost}_{(SFC,4)}+ s_{t5} \mathrm{TF\:cost}(t)$
%%%%%
%%%%%\vspace{0.25cm}
%%%%%
%%%%%where $\mathrm{TF\:cost}(t) = \frac{s_{t1}\mathrm{cost}_{(FP,1)}+ \cdots + s_{t4} \mathrm{cost}_{(FP,4)}}{s_{t1}+ \cdots +s_{t4}}$
%%%%%{\small (average cost over states, weighted by time spent in each state, under old treatment)}
%%%%%
%%%%%\vspace{0.25cm}
%%%%%
%%%%%Utility measure is the number of weeks in the successfully controlled state
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}[fragile]
%%%%%
%%%%%\frametitle{Coding this in \bugs}
%%%%%%\vspace{-1.5cm}
%%%%%
%%%%%{\footnotesize 
%%%%%\begin{verbatim}
%%%%%## Cost at time t from Markov model 
%%%%%for(t in 2:13){
%%%%%    weekly.cost.tf.fp[t] <- ## cost of TF at time t
%%%%%        inprod(s.fp[t,1:4],weekly.cost.fp[1:4])/sum(s.fp[t,]) 
%%%%%    cost.sfc[t] <- inprod(s.sfc[t,1:4],weekly.cost.sfc[1:4])
%%%%%        + s.sfc[t,5]*weekly.cost.tf.fp[t]  
%%%%%    cost.fp[t]  <- inprod(s.fp[t,1:4],weekly.cost.fp[1:4])
%%%%%        + s.fp[t,5]*weekly.cost.tf.fp[t]
%%%%%}
%%%%%## Costs and utilities
%%%%%mu.c[1] <- sum(cost.fp[2:13])
%%%%%mu.c[2] <- sum(cost.sfc[2:13])
%%%%%delta.c <- mu.c[2] - mu.c[1]
%%%%%mu.e[1] <- sum(s.fp[2:13,1])
%%%%%mu.e[2] <- sum(s.sfc[2:13,1])
%%%%%delta.e <- mu.e[2] - mu.e[1]
%%%%%\end{verbatim}
%%%%%}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{At each iteration of the MCMC sampler}
%%%%%%\vspace{-1.5cm}
%%%%%
%%%%%\begin{description}
%%%%%\item[Step 1] Set up
%%%%%\bi
%%%%%\item draw a realization of the transition probabilities $\Pi$ from their posterior distribution 
%%%%%\item define starting state and set $t=1$
%%%%%\ei
%%%%%
%%%%%\item[Step 2] Markov model
%%%%%\bi
%%%%%\item $t=t+1$
%%%%%\item find state proportions $s_t$ in each arm
%%%%%\item find cost of these state proportions in each arm
%%%%%\item repeat step 2 until $t=13$
%%%%%\ei
%%%%%
%%%%%\item[Step 3] Cost-effectiveness
%%%%%\bi
%%%%%\item find total \alert{costs} in each arm
%%%%%\item find total \alert{benefit} (proportion of time spent in STW) in each arm
%%%%%\ei
%%%%%\end{description}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Results}
%%%%%%\vspace{-1.5cm}
%%%%%
%%%%%Sample from \alert{joint posterior distribution} of costs and effects
%%%%%for each treatment gives, e.g. 
%%%%%\begin{itemize}
%%%%%\item \alert{incremental cost-effectiveness ratio} = mean cost difference / mean benefit difference
%%%%%\item ``cost-effectiveness plane''
%%%%%\item incremental net benefit (with CI)
%%%%%\item cost-effectiveness acceptability curve
%%%%%\end{itemize}
%%%%%
%%%%%\begin{center}
%%%%%\rotatebox{0}{\includegraphics[height=4cm]{11.markov-models/figs/markov5-contour.pdf}}
%%%%%\rotatebox{0}{\includegraphics[height=4cm]{11.markov-models/figs//markov5-ceac.pdf}}
%%%%%\end{center}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%
%%%%%
%%%%%
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Using \bugs in general health economic models}
%%%%%
%%%%%Typical decision models developed in spreadsheets, evidence based on meta-analysis 
%%%%%
%%%%%\bi
%%%%%\item Could do Asthma model entirely in Excel because the posterior is
%%%%%  available in closed form
%%%%%
%%%%%\item \bugs needed for more complex meta-analysis / evidence
%%%%%  syntheses.
%%%%%
%%%%%\item $\ldots$ but not necessarily the easiest software for decision modelling 
%%%%%
%%%%%\item Combine the advantages of Bayesian inference with the
%%%%%  familiarity of a spreadsheet --- \alert{use \bugs output in
%%%%%    Excel$\ldots$}
%%%%%\ei
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%\begin{frame}
%%%%%  \frametitle{Using \bugs output in a spreadsheet model}
%%%%%  \begin{itemize}
%%%%%  \item \texttt{Inference->Samples->coda} button in \openbugs generates
%%%%%    posterior sample for all monitored variables
%%%%%
%%%%%  \item Manipulate this awkward format into one column per variable 
%%%%%    \begin{itemize}
%%%%%    \item e.g. by using R  \texttt{coda} package
%%%%%    \item or, \emph{BUS --- BUGS Utility for Spreadsheets}. \url{http://faculty.salisbury.edu/~edhahn/bus.htm}
%%%%%    \end{itemize}
%%%%%
%%%%%\begin{center}
%%%%%\rotatebox{0}{\includegraphics[height=3.5cm]{11.markov-models/figs/bugsout.png}}
%%%%%\end{center}
%%%%%
%%%%%\item
%%%%%  In one iteration of probabilistic sensitivity analysis --- take parameter values from the same MCMC iteration.     
%%%%%  \end{itemize}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Advantages of fully Bayesian economic models}
%%%%%
%%%%%Using posterior distributions from \bugs:
%%%%%\bi 
%%%%%
%%%%%\item Gives an \alert{exact} posterior representing parameter
%%%%%  uncertainties
%%%%%  \begin{itemize}
%%%%%  \item instead of Normal/beta/etc. approximations used in typical
%%%%%    probabilistic spreadsheet model
%%%%%  \end{itemize}
%%%%%
%%%%%\item Accounts for \alert{correlations} between parameters
%%%%%  \begin{itemize}
%%%%%  \item instead of common assumption that uncertainty distributions
%%%%%    are independent
%%%%%  \end{itemize}
%%%%%
%%%%%\ei
%%%%%
%%%%%See NICE Decision Support Unit technical document: \emph{Embedding evidence synthesis in probabilistic cost-effectiveness analysis: software choices} from \url{http://www.nicedsu.org.uk}
%%%%%  
%%%%%\end{frame}
%%%%%
%%%%%
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%\begin{frame}
%%%%%
%%%%%\frametitle{Further reading: continuous-time Markov models}
%%%%%
%%%%%\begin{itemize}
%%%%%\item \alert{Discrete-time} models -- health state can only change at the
%%%%%  start of the \emph{cycle} (e.g. week / month).  May be good
%%%%%  approximation
%%%%%
%%%%%\item \alert{Continuous-time} models -- can change state at any time --
%%%%%  more realistic, though mathematically harder. 
%%%%%
%%%%%  \begin{itemize}
%%%%%
%%%%%  \item Expressed in terms of \emph{transition intensities} (like the
%%%%%    \emph{hazard} in survival analysis), giving instantaneous
%%%%%    \emph{rate} of moving to each other state -- use to calculate
%%%%%    probability of occupying each state a given time in the future.
%%%%%
%%%%%  \item See Welton et al. \emph{Evidence Synthesis for Decision Making
%%%%%      in Healthcare} (Wiley, 2012), for methods and WinBUGS examples.
%%%%%
%%%%%  \item Also \texttt{msm} package for the R software (Jackson et al.,
%%%%%    2003) for fitting them to disease progression data.
%%%%%
%%%%%  \end{itemize}
%%%%%
%%%%%\end{itemize}
%%%%%
%%%%%\end{frame}
%%%%%
%%%%%
%%%%%%### New page ############################################################
%%%%%
%%%%%
%%%%%\begin{frame}
%%%%%  \frametitle{Practical: Markov Models} 
%%%%%
%%%%%  \textbf{Objectives}
%%%%%
%%%%%  \begin{itemize}
%%%%%
%%%%%  \item In the drug example in Lecture 3, we determined the exact
%%%%%    posterior distribution for the probability of an event after
%%%%%    observing data (Beta prior / Binomial likelihood), using:
%%%%%    \begin{itemize}
%%%%%    \item Monte Carlo in \bugs to simulate from the known posterior
%%%%%    \item MCMC in \bugs to simulate indirectly from it, given
%%%%%      data
%%%%%    \end{itemize}
%%%%%
%%%%%  \item Here we determine an exact posterior distribution for a
%%%%%    \alert{set} of probabilities for \alert{mutually exclusive}
%%%%%    events: the state in the next week, using
%%%%%    \begin{itemize}
%%%%%    \item Monte Carlo in \bugs to simulate from the known posterior
%%%%%    \item MCMC in \bugs to simulate indirectly from it, given
%%%%%      data
%%%%%    \end{itemize}
%%%%%
%%%%%  \item Forming a simplified Markov model by merging states
%%%%%    \begin{itemize}
%%%%%    \item performing cost-effectiveness analysis using this model. 
%%%%%    \end{itemize}
%%%%%
%%%%%
%%%%%  \end{itemize}
%%%%%
%%%%%  
%%%%%\end{frame}
%%%%%
%%%%%
%%%%%%%% Local Variables:
%%%%%%%% mode: latex
%%%%%%%% TeX-master: "../talks_cjtmp"
%%%%%%%% End:
